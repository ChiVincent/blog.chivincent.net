---
title: "Docker 與 Laravel 的實踐（三）：Testing"
date: 2019-06-30T14:52:57+08:00
draft: false
categories:
    - Deployment Envrionment
tags:
    - PHP
    - Laravel
    - Docker
---

> 「Container 的技術有利於簡化測試。」，ㄏㄏ。

# 前言

## 系列文
- [Docker 與 Laravel 的實踐（一）：Local](/post/docker-與-laravel-的實踐一local/)
- [Docker 與 Laravel 的實踐（二）：Development](/post/docker-與-laravel-的實踐二development)
- Docker 與 Laravel 的實踐（三）：Testing（本文）

## 文章適用對象
- 使用 Laravel 開發的工程師，希望整合自動化測試

# 實作

## 需求

- Docker
    - 17.05 以上版本：因為使用 Multi-Stage Builds
- Docker Compose
- 看完 [Docker 與 Laravel 的實踐（二）：Development](/post/docker-與-laravel-的實踐二development)
    - 假設已經[實作專案的 Dockerfile](/post/docker-%E8%88%87-laravel-%E7%9A%84%E5%AF%A6%E8%B8%90%E4%BA%8Cdevelopment/#step-1-%E5%BB%BA%E7%AB%8B%E5%B0%88%E6%A1%88%E7%9A%84-dockerfile)

## 步驟

統一將環境放在 `.docker/testing` 資料夾下（如果沒有這個資料夾請自行建立）

### Step 1. 調整 Laravel 的測試設定

在 `config/database.php` 中的 `connections` 加入 In Memory SQLite

```php
<?php
return [
    // Ignore ...
    'connections' => [
        // Ignore ...
        'sqlite_testing' => [
            'driver' => 'sqlite',
            'database' => ':memory:',
            'prefix' => '',
            'foreign_key_constraints' => true,
        ],
        // Ignore ...
    ],
    // Ignore ...
]
```

### Step 2. 建立 Testing 的 Dockerfile

建立 `.docker/testing/Dockerfile`

```Dockerfile
FROM {project_name} AS code

FROM php:alpine

ENV APP_KEY="Input Your Application Key, Generated By Laravel"

WORKDIR /www

COPY --from=code /build /www

CMD ["php", "vendor/bin/phpunit"]
```

建立 Dockerfile 之後，使用 `docker build -t {project_name}/testing .` 建立 Testing Docker Image。

## 整合

### GitLab CI

```yaml
stages:
  - build-code
  - build
  - testing

build-main-image:
  image: docker

  services:
    - docker:dind

  stage: build-code

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - docker build -t registry.gitlab.com/group_name/repo_name .
    - docker push registry.gitlab.com/group_name/repo_name

build-testing-image:
    image: docker

    services:
        - docker:dind
    
    stage: build

    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWROD $CI_REGISTRY
    
    script:
        - docker build -t registry.gitlab.com/group_name/repo_name .
        - docker push registry.gitlab.com/group_name/repo_name

fast-test:
    image: registry.gitlab.com/group_name/repo_name

    stage: test

    environments:
        - DB_CONNECTION=sqlite_testing

    script:
        - cd /www
        - php vendor/bin/phpunit
```

此處僅定義了由 In Memory SQLite 執行測試的 `fast-test`

實務上應該還需要一個 `complete-test`，使用一樣的 test image，然後啟動與正式環境差不多的服務（如資料庫），這樣測試時雖然會慢不少，但是有助於進行比較完整的測試。

※ pdo_sqlite 是 php:alpine 中內建的 extension，所以不需要另外安裝
※ 最終環境變數會根據 CI 時期的 environments 進行修改，所以 Dockerfile 中不宜將 config cache 起來